# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v9.h5"
extracted_expression_file = "Neural Stem Cells_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v9.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1944034","GSM1277972","GSM1277973","GSM1277971","GSM1944033","GSM1381226","GSM1381231","GSM2228431","GSM2228432","GSM1381233","GSM1381228","GSM1381237","GSM1381238","GSM2228435","GSM2228433","GSM1381232","GSM1381235","GSM1381234","GSM1381229","GSM1381236","GSM1381239","GSM1381230","GSM1381227","GSM2228434","GSM2302970","GSM2302971","GSM2302972","GSM2302973","GSM2302974","GSM2302975","GSM2302976",
"GSM2302977","GSM2302978","GSM2302979","GSM2302980","GSM2302981","GSM2302982","GSM2302983","GSM2302984","GSM2302985","GSM2302986","GSM2302987","GSM2302988","GSM2928169","GSM2928170","GSM2928171","GSM2928172","GSM2928173","GSM2928174","GSM2928175","GSM2928176","GSM2928177","GSM2928178","GSM2928179","GSM2928180","GSM2928181","GSM2928182","GSM2928183","GSM2948443","GSM2948444","GSM2948445",
"GSM2948446","GSM2948447","GSM2948448","GSM2587324","GSM2452280","GSM2452281","GSM2452282","GSM2452283","GSM2452284","GSM2452285","GSM2452286","GSM2452287","GSM2452288","GSM2452289","GSM2452290","GSM2452291","GSM2452292","GSM2452293","GSM2452294","GSM2452295","GSM2452296","GSM2452297","GSM3044658","GSM3044659","GSM3044660","GSM3044661","GSM3044662","GSM3044663","GSM3044664","GSM3044665",
"GSM3044666","GSM3044667","GSM3044668","GSM3044669","GSM3307969","GSM3307970","GSM3307971","GSM3477322","GSM3477323","GSM3477324","GSM3477325","GSM3380661","GSM3380662","GSM3380663","GSM3380664","GSM3384847","GSM3384848","GSM3384849","GSM3384850","GSM3384851","GSM3384852","GSM3384853","GSM3384854","GSM3384855","GSM2792952","GSM2792953","GSM2792954","GSM2792955","GSM2792956","GSM2792957",
"GSM2792958","GSM2792959","GSM2792960","GSM2792961","GSM2792962","GSM2792963","GSM2792964","GSM2792965","GSM2792966","GSM2792967","GSM2792968","GSM2792969","GSM2792970","GSM2792971","GSM3561461","GSM3590948","GSM3590949","GSM3590950","GSM3590951","GSM4058994","GSM4058995","GSM4058996","GSM4058997","GSM4118987","GSM4118988","GSM4118989","GSM4118990","GSM4118991","GSM4118992","GSM2308275",
"GSM3305820","GSM3305821","GSM3305822","GSM3305823","GSM3305824","GSM3305825","GSM3305826","GSM3305827","GSM3305828","GSM3625356","GSM3625357","GSM3625358","GSM3625359","GSM3625360","GSM3625361","GSM3625362","GSM3625363","GSM3625364","GSM3625365","GSM3625366","GSM3625367","GSM3625368","GSM3625369","GSM3625370","GSM3625371","GSM3625372","GSM3625373","GSM3625374","GSM3625375","GSM3625376",
"GSM3625377","GSM3625378","GSM3625379","GSM3625380","GSM3625381","GSM3625382","GSM3625383","GSM3625384","GSM3625385","GSM3625386","GSM3625387","GSM3625388","GSM3625389","GSM3625390","GSM3625391","GSM3625392","GSM3625393","GSM3625394","GSM3625395","GSM3625396","GSM3625397","GSM3625398","GSM3625399","GSM3625400","GSM3625401","GSM3625402","GSM3625403","GSM3625404","GSM3625405","GSM3625406",
"GSM3625407","GSM3625408","GSM3625409","GSM3625410","GSM3625411","GSM3625412","GSM3625413","GSM3625414","GSM4064147","GSM1944034","GSM1277972","GSM1277973","GSM1277971","GSM1944033","GSM1381226","GSM1381231","GSM2228431","GSM2228432","GSM1381233","GSM1381228","GSM1381237","GSM1381238","GSM2228435","GSM2228433","GSM1381232","GSM1381235","GSM1381234","GSM1381229","GSM1381236","GSM1381239",
"GSM1381230","GSM1381227","GSM2228434","GSM2302970","GSM2302971","GSM2302972","GSM2302973","GSM2302974","GSM2302975","GSM2302976","GSM2302977","GSM2302978","GSM2302979","GSM2302980","GSM2302981","GSM2302982","GSM2302983","GSM2302984","GSM2302985","GSM2302986","GSM2302987","GSM2302988","GSM2928169","GSM2928170","GSM2928171","GSM2928172","GSM2928173","GSM2928174","GSM2928175","GSM2928176",
"GSM2928177","GSM2928178","GSM2928179","GSM2928180","GSM2928181","GSM2928182","GSM2928183","GSM2948443","GSM2948444","GSM2948445","GSM2948446","GSM2948447","GSM2948448","GSM2587324","GSM2452280","GSM2452281","GSM2452282","GSM2452283","GSM2452284","GSM2452285","GSM2452286","GSM2452287","GSM2452288","GSM2452289","GSM2452290","GSM2452291","GSM2452292","GSM2452293","GSM2452294","GSM2452295",
"GSM2452296","GSM2452297","GSM3044658","GSM3044659","GSM3044660","GSM3044661","GSM3044662","GSM3044663","GSM3044664","GSM3044665","GSM3044666","GSM3044667","GSM3044668","GSM3044669","GSM3307969","GSM3307970","GSM3307971","GSM3477322","GSM3477323","GSM3477324","GSM3477325","GSM3380661","GSM3380662","GSM3380663","GSM3380664","GSM3384847","GSM3384848","GSM3384849","GSM3384850","GSM3384851",
"GSM3384852","GSM3384853","GSM3384854","GSM3384855","GSM2792952","GSM2792953","GSM2792954","GSM2792955","GSM2792956","GSM2792957","GSM2792958","GSM2792959","GSM2792960","GSM2792961","GSM2792962","GSM2792963","GSM2792964","GSM2792965","GSM2792966","GSM2792967","GSM2792968","GSM2792969","GSM2792970","GSM2792971","GSM3561461","GSM3590948","GSM3590949","GSM3590950","GSM3590951","GSM4058994",
"GSM4058995","GSM4058996","GSM4058997","GSM4118987","GSM4118988","GSM4118989","GSM4118990","GSM4118991","GSM4118992","GSM2308275","GSM3305820","GSM3305821","GSM3305822","GSM3305823","GSM3305824","GSM3305825","GSM3305826","GSM3305827","GSM3305828","GSM3625356","GSM3625357","GSM3625358","GSM3625359","GSM3625360","GSM3625361","GSM3625362","GSM3625363","GSM3625364","GSM3625365","GSM3625366",
"GSM3625367","GSM3625368","GSM3625369","GSM3625370","GSM3625371","GSM3625372","GSM3625373","GSM3625374","GSM3625375","GSM3625376","GSM3625377","GSM3625378","GSM3625379","GSM3625380","GSM3625381","GSM3625382","GSM3625383","GSM3625384","GSM3625385","GSM3625386","GSM3625387","GSM3625388","GSM3625389","GSM3625390","GSM3625391","GSM3625392","GSM3625393","GSM3625394","GSM3625395","GSM3625396",
"GSM3625397","GSM3625398","GSM3625399","GSM3625400","GSM3625401","GSM3625402","GSM3625403","GSM3625404","GSM3625405","GSM3625406","GSM3625407","GSM3625408","GSM3625409","GSM3625410","GSM3625411","GSM3625412","GSM3625413","GSM3625414","GSM4064147","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

